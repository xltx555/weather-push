name: Daily Weather Push

on:
  workflow_dispatch:  # 手动触发
  schedule:
    # 北京时间 8:00、12:00、22:00 触发（UTC时间-8小时）
    - cron: '0 0,4,14 * * *'

jobs:
  send_weather:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install UTF-8 locale
        run: |
          sudo apt-get update
          sudo apt-get install -y locales
          sudo locale-gen en_US.UTF-8

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests schedule

      - name: Run script
        env:
          # 使用通用的 en_US.UTF-8 编码，避免语言包缺失问题
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          PYTHONIOENCODING: utf-8
          # 从 Secrets 读取配置
          WEATHER_KEY: ${{ secrets.WEATHER_KEY }}
          WEATHER_HOST: ${{ secrets.WEATHER_HOST }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PWD: ${{ secrets.SMTP_PWD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: python main.py
